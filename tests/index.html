<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Match Recorder - Test Framework</title>
    <link rel="stylesheet" href="css/test-styles.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Tennis Match Recorder - Test Framework</h1>
        
        <!-- Control Panel -->
        <div class="control-panel">
            <h2>Test Configuration</h2>
            
            <div class="control-group">
                <label for="match-count">Number of Matches (1-100):</label>
                <input type="number" id="match-count" min="1" max="100" value="10">
            </div>
            
            <div class="control-group">
                <label>Test Scenarios:</label>
                <div class="scenario-selector" id="scenario-selector">
                    <!-- Scenarios will be populated by JavaScript -->
                </div>
                <button class="btn btn-secondary" id="select-all-btn">Select All</button>
                <button class="btn btn-secondary" id="deselect-all-btn">Deselect All</button>
            </div>
            
            <button class="btn btn-primary" id="run-tests-btn">Run Tests</button>
            <button class="btn btn-danger" id="stop-tests-btn" style="display: none;">Stop Tests</button>
        </div>
        
        <!-- Progress Bar -->
        <div class="progress-container" id="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
            </div>
            <div class="progress-text" id="progress-text">Preparing tests...</div>
        </div>
        
        <!-- Results Section -->
        <div class="results-section" id="results-section" style="display: none;">
            <h2>Test Results</h2>
            
            <!-- Summary -->
            <div class="summary" id="summary">
                <h3>Summary</h3>
                <div class="summary-stats" id="summary-stats">
                    <!-- Summary stats will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Charts -->
            <div class="charts-container" id="charts-container">
                <!-- Charts will be generated by ResultVisualizer -->
            </div>
            
            <!-- Differences List -->
            <div class="differences-list" id="differences-list">
                <h3>Failed Tests</h3>
                <div id="differences-content">
                    <!-- Differences will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Test Results Table -->
            <div id="results-table-container">
                <h3>All Test Results</h3>
                <table class="results-table" id="results-table">
                    <thead>
                        <tr>
                            <th>Scenario</th>
                            <th>Match #</th>
                            <th>Status</th>
                            <th>Differences</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body">
                        <!-- Results will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal for test details -->
    <!-- 测试详情模态窗口 -->
    <div id="test-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Test Details</h2>
                <span class="modal-close" onclick="closeTestDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="details-content" id="test-details-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="copyTestDetails()">Copy to Clipboard</button>
                <button class="btn btn-secondary" onclick="closeTestDetailsModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Load dependencies -->
    <!-- 加载依赖 -->
    <script src="../js/models.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/match-engine.js"></script>
    <script src="../js/statistics.js"></script>
    
    <!-- Load test framework -->
    <!-- 加载测试框架 -->
    <script src="utils/point-tracker.js"></script>
    <script src="agents/match-simulator.js"></script>
    <script src="agents/statistics-validator.js"></script>
    <script src="agents/score-validator.js"></script>
    <script src="agents/test-runner.js"></script>
    <script src="utils/result-visualizer.js"></script>
    <script src="test-cases/test-scenarios.js"></script>
    
    <!-- Main test application -->
    <!-- 主测试应用 -->
    <script>
        // Global variables
        // 全局变量
        let testRunner = null;
        let resultVisualizer = null;
        let currentTestResults = null;
        let isRunning = false;
        let shouldStop = false;
        
        // Initialize
        // 初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // Ensure storage is initialized
            // 确保storage已初始化
            if (typeof storage !== 'undefined') {
                try {
                    await storage.init();
                } catch (error) {
                    console.warn('Storage initialization warning:', error);
                }
            }
            
            initializeUI();
            setupEventListeners();
        });
        
        // Initialize UI
        // 初始化UI
        function initializeUI() {
            // Populate scenario selector
            // 填充场景选择器
            const scenarioSelector = document.getElementById('scenario-selector');
            scenarioSelector.innerHTML = '';
            
            TestScenarios.forEach((scenario, index) => {
                const checkbox = document.createElement('div');
                checkbox.className = 'scenario-checkbox';
                checkbox.innerHTML = `
                    <label>
                        <input type="checkbox" value="${index}" checked>
                        ${scenario.name}
                    </label>
                `;
                scenarioSelector.appendChild(checkbox);
            });
            
            // Initialize visualizer
            // 初始化可视化器
            resultVisualizer = new ResultVisualizer();
        }
        
        // Setup event listeners
        // 设置事件监听器
        function setupEventListeners() {
            document.getElementById('run-tests-btn').addEventListener('click', runTests);
            document.getElementById('stop-tests-btn').addEventListener('click', stopTests);
            document.getElementById('select-all-btn').addEventListener('click', selectAllScenarios);
            document.getElementById('deselect-all-btn').addEventListener('click', deselectAllScenarios);
        }
        
        // Select all scenarios
        // 选择所有场景
        function selectAllScenarios() {
            const checkboxes = document.querySelectorAll('#scenario-selector input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        }
        
        // Deselect all scenarios
        // 取消选择所有场景
        function deselectAllScenarios() {
            const checkboxes = document.querySelectorAll('#scenario-selector input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        }
        
        // Get selected scenarios
        // 获取选中的场景
        function getSelectedScenarios() {
            const checkboxes = document.querySelectorAll('#scenario-selector input[type="checkbox"]:checked');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
            return TestScenarios.filter((_, index) => selectedIndices.includes(index));
        }
        
        // Run tests
        // 运行测试
        async function runTests() {
            if (isRunning) {
                return;
            }
            
            // Get configuration
            // 获取配置
            const matchCount = parseInt(document.getElementById('match-count').value) || 10;
            const selectedScenarios = getSelectedScenarios();
            
            if (selectedScenarios.length === 0) {
                alert('Please select at least one test scenario');
                return;
            }
            
            if (matchCount < 1 || matchCount > 100) {
                alert('Number of matches must be between 1 and 100');
                return;
            }
            
            // Reset state
            // 重置状态
            isRunning = true;
            shouldStop = false;
            document.getElementById('run-tests-btn').disabled = true;
            document.getElementById('stop-tests-btn').style.display = 'inline-block';
            document.getElementById('progress-container').classList.add('active');
            document.getElementById('results-section').style.display = 'none';
            
            // Initialize test runner
            // 初始化测试运行器
            testRunner = new TestRunner();
            
            // Progress callback
            // 进度回调
            const progressCallback = (progress) => {
                if (shouldStop) {
                    return;
                }
                
                const percentage = (progress.total / (selectedScenarios.length * matchCount)) * 100;
                document.getElementById('progress-fill').style.width = percentage + '%';
                document.getElementById('progress-fill').textContent = Math.round(percentage) + '%';
                document.getElementById('progress-text').textContent = 
                    `Running: ${progress.current.scenario} - Match ${progress.current.matchIndex} (${progress.passed} passed, ${progress.failed} failed)`;
            };
            
            try {
                // Run tests
                // 运行测试
                const testResults = await testRunner.runTests(selectedScenarios, matchCount, progressCallback);
                currentTestResults = testResults;
                
                if (!shouldStop) {
                    // Display results
                    // 显示结果
                    displayResults(testResults);
                }
            } catch (error) {
                console.error('Error running tests:', error);
                alert('Error running tests: ' + error.message);
            } finally {
                // Reset state
                // 重置状态
                isRunning = false;
                document.getElementById('run-tests-btn').disabled = false;
                document.getElementById('stop-tests-btn').style.display = 'none';
                document.getElementById('progress-container').classList.remove('active');
            }
        }
        
        // Stop tests
        // 停止测试
        function stopTests() {
            shouldStop = true;
            isRunning = false;
            document.getElementById('run-tests-btn').disabled = false;
            document.getElementById('stop-tests-btn').style.display = 'none';
            document.getElementById('progress-text').textContent = 'Tests stopped by user';
        }
        
        // Display results
        // 显示结果
        function displayResults(testResults) {
            // Show results section
            // 显示结果部分
            document.getElementById('results-section').style.display = 'block';
            
            // Update summary
            // 更新摘要
            const summary = testResults.summary;
            const summaryDiv = document.getElementById('summary');
            summaryDiv.className = summary.failed > 0 ? 'summary failed' : 'summary';
            
            document.getElementById('summary-stats').innerHTML = `
                <div class="summary-stat">
                    <div class="summary-stat-value">${summary.totalMatches}</div>
                    <div class="summary-stat-label">Total Matches</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" style="color: #4CAF50;">${summary.passed}</div>
                    <div class="summary-stat-label">Passed</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" style="color: #F44336;">${summary.failed}</div>
                    <div class="summary-stat-label">Failed</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value">${summary.passRate}</div>
                    <div class="summary-stat-label">Pass Rate</div>
                </div>
            `;
            
            // Generate charts
            // 生成图表
            resultVisualizer.createCharts(testResults, 'charts-container');
            
            // Display differences
            // 显示差异
            displayDifferences(testResults);
            
            // Display results table
            // 显示结果表格
            displayResultsTable(testResults);
        }
        
        // Display differences
        // 显示差异
        function displayDifferences(testResults) {
            const differencesContent = document.getElementById('differences-content');
            differencesContent.innerHTML = '';
            
            const failedResults = testResults.results.filter(r => !r.passed);
            
            if (failedResults.length === 0) {
                differencesContent.innerHTML = '<p>No differences found. All tests passed!</p>';
                return;
            }
            
            failedResults.forEach((result, index) => {
                const differenceItem = document.createElement('div');
                differenceItem.className = 'difference-item failed';
                differenceItem.innerHTML = `
                    <div class="difference-item-header">
                        ${result.scenario} - Match ${result.matchIndex + 1}
                    </div>
                    <div class="difference-item-details">
                        <strong>Differences:</strong> ${result.differences.length}
                        <br>
                        ${result.differences.slice(0, 5).map(d => d.message).join('<br>')}
                        ${result.differences.length > 5 ? `<br>... and ${result.differences.length - 5} more` : ''}
                    </div>
                    <button class="point-sequence-toggle" onclick="togglePointSequence(${index})">
                        View Point Sequence
                    </button>
                    <div class="point-sequence-content" id="point-sequence-${index}">
                        ${formatPointSequence(result.pointSequence)}
                    </div>
                `;
                differencesContent.appendChild(differenceItem);
            });
        }
        
        // Toggle point sequence
        // 切换point序列
        function togglePointSequence(index) {
            const content = document.getElementById(`point-sequence-${index}`);
            content.classList.toggle('expanded');
        }
        
        // Format point sequence
        // 格式化point序列
        function formatPointSequence(points) {
            if (!points || points.length === 0) {
                return '<p>No points recorded</p>';
            }
            
            return points.map((point, idx) => {
                return `
                    <div class="point-item">
                        <div class="point-item-header">
                            Point ${point.pointNumber || idx + 1}: ${point.winner || 'N/A'} - ${point.pointType || 'N/A'}
                        </div>
                        <div class="point-item-details">
                            Server: ${point.server || 'N/A'}, Serve: ${point.serveNumber || 'N/A'}, 
                            Shot: ${point.shotType || 'N/A'}<br>
                            Game: ${point.gameScore || 'N/A'}, Games: ${point.gamesScore || 'N/A'}, 
                            Sets: ${point.setsScore || 'N/A'}<br>
                            Break Point: ${point.isBreakPoint ? 'Yes' : 'No'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Display results table
        // 显示结果表格
        function displayResultsTable(testResults) {
            const tbody = document.getElementById('results-table-body');
            tbody.innerHTML = '';
            
            testResults.results.forEach((result, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.scenario}</td>
                    <td>${result.matchIndex + 1}</td>
                    <td class="status-${result.passed ? 'passed' : 'failed'}">
                        ${result.passed ? 'PASSED' : 'FAILED'}
                    </td>
                    <td>${result.differences ? result.differences.length : 0}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewTestDetails(${index}); window.currentTestDetailsIndex = ${index};">
                            View Details
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // View test details
        // 查看测试详情
        function viewTestDetails(index) {
            if (!currentTestResults || !currentTestResults.results[index]) {
                return;
            }
            
            const result = currentTestResults.results[index];
            const contentDiv = document.getElementById('test-details-content');
            
            // Build details HTML
            // 构建详情HTML
            let detailsHTML = `
                <div class="detail-section">
                    <h3>Test Information</h3>
                    <p><strong>Scenario:</strong> ${result.scenario}</p>
                    <p><strong>Match Index:</strong> ${result.matchIndex + 1}</p>
                    <p><strong>Status:</strong> <span class="status-${result.passed ? 'passed' : 'failed'}">${result.passed ? 'PASSED' : 'FAILED'}</span></p>
                    <p><strong>Differences:</strong> ${result.differences ? result.differences.length : 0}</p>
                    <p><strong>Point Sequence:</strong> ${result.pointSequence ? result.pointSequence.length : 0} points</p>
                </div>
            `;
            
            // Add score comparison
            // 添加分数比较
            if (result.match && result.expectedScores) {
                const programScore = result.match.sets ? result.match.sets.map(s => 
                    `${s.player1Games}-${s.player2Games}${s.tieBreak ? `(${s.tieBreak.player1Points}-${s.tieBreak.player2Points})` : ''}`
                ).join(' ') : 'N/A';
                const expectedScore = result.expectedScores.finalScore || 'N/A';
                
                detailsHTML += `
                    <div class="detail-section">
                        <h3>Score Comparison</h3>
                        <p><strong>Program Score:</strong> ${programScore}</p>
                        <p><strong>Expected Score:</strong> ${expectedScore}</p>
                        <p><strong>Match Winner:</strong> Program=${result.match.winner || 'N/A'}, Expected=${result.expectedScores.winner || 'N/A'}</p>
                    </div>
                `;
            }
            
            // Add differences
            // 添加差异
            if (result.differences && result.differences.length > 0) {
                // Separate score differences from statistics differences
                // 将分数差异与统计差异分开
                const scoreDifferences = result.differences.filter(d => d.type === 'score_mismatch');
                const statDifferences = result.differences.filter(d => d.type !== 'score_mismatch');
                
                if (scoreDifferences.length > 0) {
                    detailsHTML += `
                        <div class="detail-section">
                            <h3>Score Differences</h3>
                            <pre class="differences-text">${scoreDifferences.map(d => d.message || `${d.category}: program=${d.programValue}, expected=${d.expectedValue}`).join('\n')}</pre>
                        </div>
                    `;
                }
                
                // Separate server differences
                // 分离发球权差异
                const serverDifferences = result.differences.filter(d => d.type === 'server_mismatch');
                if (serverDifferences.length > 0) {
                    detailsHTML += `
                        <div class="detail-section">
                            <h3>Server Assignment Differences</h3>
                            <pre class="differences-text">${serverDifferences.map(d => d.message || `Point ${d.pointNumber}: program server=${d.programValue}, expected=${d.expectedValue}`).join('\n')}</pre>
                        </div>
                    `;
                }
                
                if (statDifferences.length > 0) {
                    detailsHTML += `
                        <div class="detail-section">
                            <h3>Statistics Differences</h3>
                            <pre class="differences-text" id="differences-text">${statDifferences.map(d => {
                                let diffText = `${d.player || 'unknown'} ${d.statistic || d.shotType || d.type || 'unknown'}: `;
                                if (d.programValue !== undefined) {
                                    diffText += `program=${d.programValue}`;
                                }
                                if (d.expectedValue !== undefined) {
                                    diffText += `, expected=${d.expectedValue}`;
                                }
                                if (d.difference !== undefined) {
                                    diffText += ` (difference: ${d.difference})`;
                                }
                                if (d.message) {
                                    diffText += ` - ${d.message}`;
                                }
                                return diffText;
                            }).join('\n')}</pre>
                        </div>
                    `;
                }
            } else {
                detailsHTML += `
                    <div class="detail-section">
                        <h3>Differences</h3>
                        <p>No differences found.</p>
                    </div>
                `;
            }
            
            // Add point sequence summary
            // 添加point序列摘要
            if (result.pointSequence && result.pointSequence.length > 0) {
                const doubleFaults = result.pointSequence.filter(p => p.pointType === 'Double Fault');
                const doubleFaultsWithoutServer = doubleFaults.filter(p => !p.server);
                const doubleFaultsByPlayer = {
                    player1: doubleFaults.filter(p => p.server === 'player1').length,
                    player2: doubleFaults.filter(p => p.server === 'player2').length,
                    noServer: doubleFaultsWithoutServer.length
                };
                
                // Check match.log for Double Fault entries
                // 检查match.log中的Double Fault条目
                let matchLogDoubleFaults = [];
                if (result.match && result.match.log) {
                    matchLogDoubleFaults = result.match.log.filter(e => e.action === 'Double Fault');
                }
                const matchLogDoubleFaultsByServer = {
                    player1: matchLogDoubleFaults.filter(e => e.server === 'player1').length,
                    player2: matchLogDoubleFaults.filter(e => e.server === 'player2').length,
                    noServer: matchLogDoubleFaults.filter(e => !e.server).length
                };
                
                detailsHTML += `
                    <div class="detail-section">
                        <h3>Point Sequence Summary</h3>
                        <p>Total Points: ${result.pointSequence.length}</p>
                        <p>Player 1 Points Won: ${result.pointSequence.filter(p => p.winner === 'player1').length}</p>
                        <p>Player 2 Points Won: ${result.pointSequence.filter(p => p.winner === 'player2').length}</p>
                        <p>First Serve Faults: ${result.pointSequence.filter(p => p.pointType === 'Serve Fault' && p.serveNumber === 1).length}</p>
                        <p>Double Faults: ${doubleFaults.length}</p>
                        <p><strong>Point Sequence Double Faults:</strong> Player1=${doubleFaultsByPlayer.player1}, Player2=${doubleFaultsByPlayer.player2}, NoServer=${doubleFaultsByPlayer.noServer}</p>
                        <p><strong>Match Log Double Faults:</strong> Player1=${matchLogDoubleFaultsByServer.player1}, Player2=${matchLogDoubleFaultsByServer.player2}, NoServer=${matchLogDoubleFaultsByServer.noServer}</p>
                        ${doubleFaultsWithoutServer.length > 0 ? `<p style="color: red;"><strong>Warning: ${doubleFaultsWithoutServer.length} Double Fault(s) without server field in point sequence!</strong></p>` : ''}
                        ${matchLogDoubleFaultsByServer.noServer > 0 ? `<p style="color: red;"><strong>Warning: ${matchLogDoubleFaultsByServer.noServer} Double Fault(s) without server field in match.log!</strong></p>` : ''}
                    </div>
                `;
            }
            
            contentDiv.innerHTML = detailsHTML;
            
            // Show modal
            // 显示模态窗口
            document.getElementById('test-details-modal').style.display = 'block';
        }
        
        // Close test details modal
        // 关闭测试详情模态窗口
        function closeTestDetailsModal() {
            document.getElementById('test-details-modal').style.display = 'none';
        }
        
        // Copy test details to clipboard
        // 复制测试详情到剪贴板
        function copyTestDetails() {
            const result = currentTestResults.results[window.currentTestDetailsIndex];
            if (!result) return;
            
            let text = `Test Details\n`;
            text += `===========\n\n`;
            text += `Scenario: ${result.scenario}\n`;
            text += `Match Index: ${result.matchIndex + 1}\n`;
            text += `Status: ${result.passed ? 'PASSED' : 'FAILED'}\n`;
            text += `Differences: ${result.differences ? result.differences.length : 0}\n\n`;
            
            if (result.differences && result.differences.length > 0) {
                // Separate score differences, server differences, and statistics differences
                // 将分数差异、发球权差异和统计差异分开
                const scoreDifferences = result.differences.filter(d => d.type === 'score_mismatch');
                const serverDifferences = result.differences.filter(d => d.type === 'server_mismatch');
                const statDifferences = result.differences.filter(d => d.type !== 'score_mismatch' && d.type !== 'server_mismatch');
                
                if (scoreDifferences.length > 0) {
                    text += `Score Differences:\n`;
                    text += scoreDifferences.map(d => `  - ${d.message || `${d.category}: program=${d.programValue}, expected=${d.expectedValue}`}`).join('\n');
                    text += `\n\n`;
                }
                
                if (serverDifferences.length > 0) {
                    text += `Server Assignment Differences:\n`;
                    text += serverDifferences.map(d => `  - ${d.message || `Point ${d.pointNumber}: program server=${d.programValue}, expected=${d.expectedValue}`}`).join('\n');
                    text += `\n\n`;
                }
                
                if (statDifferences.length > 0) {
                    text += `Statistics Differences:\n`;
                    text += statDifferences.map(d => {
                        let diffText = `  - ${d.player || 'unknown'} ${d.statistic || d.shotType || d.type || 'unknown'}: `;
                        if (d.programValue !== undefined) {
                            diffText += `program=${d.programValue}`;
                        }
                        if (d.expectedValue !== undefined) {
                            diffText += `, expected=${d.expectedValue}`;
                        }
                        if (d.difference !== undefined) {
                            diffText += ` (difference: ${d.difference})`;
                        }
                        if (d.message) {
                            diffText += ` - ${d.message}`;
                        }
                        return diffText;
                    }).join('\n');
                    text += `\n\n`;
                }
            }
            
            text += `Point Sequence: ${result.pointSequence ? result.pointSequence.length : 0} points\n`;
            
            // Copy to clipboard
            // 复制到剪贴板
            navigator.clipboard.writeText(text).then(() => {
                alert('Test details copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback: select text
                // 后备方案：选择文本
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('Test details copied to clipboard!');
                } catch (err) {
                    alert('Failed to copy. Please select and copy manually.');
                }
                document.body.removeChild(textArea);
            });
        }
        
        // Make functions available globally
        // 使函数在全局可用
        window.togglePointSequence = togglePointSequence;
        window.viewTestDetails = viewTestDetails;
        window.closeTestDetailsModal = closeTestDetailsModal;
        window.copyTestDetails = copyTestDetails;
        
        // Close modal when clicking outside
        // 点击外部时关闭模态窗口
        window.onclick = function(event) {
            const modal = document.getElementById('test-details-modal');
            if (event.target === modal) {
                closeTestDetailsModal();
            }
        };
    </script>
</body>
</html>

